#!/bin/sh
#
# Usage: script/bootstrap
#
# Install dependencies.

# Inspired bootstrap install scripts from:
#   davidxia's dotfiles (https://github.com/davidxia/bootstrap_dotfiles/)
#   joshdick's dotfiles (https://github.com/joshdick/dotfiles)

# Error (red, underlined)
msg_fail () {
  printf "\033[0;31;4mError\033[0m: $1 \n"
  exit 1
}

# Text (blue)
msg_run () {
  printf "\n\033[0;34m$1\033[0m \n"
}

msg_install () {
  printf "%-50s" "$1"
}

# check if cmd exists
exists () {
  command -v "$1" >/dev/null 2>&1
}


install_dotfiles () {
  msg_run "Installing dotfiles to $HOME ..."    

  # get path of dotfiles repo
  DOTFILES_ROOT="$( cd "$( dirname "$0" )" && cd .. && pwd )"

  # set global default install options
  skip_all=false
  overwrite_all=false
  backup_all=false

  # get list of all dotfiles to be symlinked
  # NOTE: assumes a dotfiles structure of topic/setting.symlink
  #       (e.g. zsh/zshrc.symlink)
  for file in `find $DOTFILES_ROOT -maxdepth 2 -name \*.symlink` ; do

    # get filename of $file (no path)
    symlink_filename=`basename "$file"`

    # create absolute path for link target
    target=`echo "$HOME/.$symlink_filename" | sed "s/\.symlink$//g"`

    # target basename
    target_name=`basename "$target"`
        
    # set default install options (per symlink file)
    skip=false
    overwrite=false
    backup=false

    # get user input if dotfiles already exist
    if [ -f $target ] || [ -d $target ] ; then
    
      if [ "$overwrite_all" = "false" ] && [ "$backup_all" = "false" ] \
        && [ "$skip_all" = "false" ] ; then 
            
        # get user input 
        printf "\033[0;31;4mError\033[0m: $target_name already exists:" 
        printf " [s]kip," 
        printf " [S]kip all," 
        printf " [o]verwrite,"
        printf " [O]verwrite all,"
        printf " [b]ackup,"
        printf " [B]ackup all? \n"
        read REPLY
        
        # apply user input 
        case "$REPLY" in
          s) skip=true ;; 
          S) skip_all=true ;;
          o) overwrite=true ;; 
          O) overwrite_all=true ;; 
          b) backup=true ;; 
          B) backup_all=true ;; 
          *) msg_fail "unknown option; quitting now ..." ;;
        esac
      fi # end if-statement for if no global options are set
            
      # delete pre-existing dotfiles
      if [ "$overwrite" = "true" ] || [ "$overwrite_all" = "true" ] ; then
        printf "Overwriting $target_name ... \n"
        rm -rf $target
      fi

      # backup pre-existing dotfiles
      if [ "$backup" = "true" ] || [ "$backup_all" = "true" ] ; then
        printf "Backing up $target_name ... \n"
        mv $target $target\.backup
      fi
    
      # linking dotfiles
      if [ "$skip" = "false" ] && [ "$skip_all" = "false" ] ; then
        ln -s $file $target
      else
        printf "Skipping $target_name ... \n"
      fi
    
    # link dotfiles if they don't already exist 
    else
      printf "Installing $target_name ... \n"
      ln -s $file $target
    fi

  done # end loop for all *.symlink files
}


brew_install () {
  installed=$(sh -c "brew info $*" | grep "Not installed")
 
  # install if not already installed
  if [ ! "$installed" = "" ] ; then
    sh -c "brew install $*" >/dev/null 2>&1
  fi

  printf "SUCCESS\n"
}

install_homebrew_pkgs () {

  if ! exists brew ; then
    echo ""
    msg_fail "Homebrew not installed; unable to continue ..."
  fi

  # update homebrew package list (silently)
  brew update >/dev/null 2>&1

  # git 
  msg_install "Installing git ..."
    brew_install git git-extras

  # shells
  msg_install "Installing zsh ..."
    brew_install --disable-etcdir zsh

  # editors
  msg_install "Installing vim ..."
    brew_install vim --override-system-vim

  msg_install "Installing macvim ..."
    brew_install macvim

  # tools
  msg_install "Installing ack ... "
    brew_install ack

  msg_install "Installing the silver searcher (ag) ..."
    brew_install the_silver_searcher

  msg_install "Installing coreutils ..."
    brew_install coreutils

  # languages
  msg_install "Installing python ..."
    brew_install python

  msg_install "Installing rbenv ..."
    brew_install rbenv ruby-build
  
  # tmux
  msg_install "Installing tmux ..."
    brew_install tmux

  msg_install "Installing reattach-to-user-namespace ..."
    brew_install reattach-to-user-namespace
}


install_vim_pkgs () {

  msg_run "Installing vim packages ..."

  # Vundle
  msg_install "Installing vundle ..."
  if [ ! -d $HOME/.vim/bundle/vundle/ ] ; then
    git clone http://github.com/gmarik/vundle.git $HOME/.vim/bundle/vundle >/dev/null 2>&1
  else
    printf "SUCCESS\n"
  fi

  msg_install "Installing vim packages ..."
  if exists vim ; then 
    vim +BundleInstall +qall >/dev/null 2>&1
    printf "SUCCESS\n"
  elif exists mvim ; then 
    mvim +BundleInstall +qall >/dev/null 2>&1
    printf "SUCCESS\n"
  else
    printf "FAILED\n"
  fi
}


install_dotfiles

# OS-specific installs
if [ $(uname -s) = "Darwin" ] ; then
  msg_run "Installing homebrew packages ..."
    install_homebrew_pkgs
fi

install_vim_pkgs

msg_run "Finished installing!"

exit 0

# vim: autoindent tabstop=2 shiftwidth=2 expandtab softtabstop=2 filetype=sh
